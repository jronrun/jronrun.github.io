"use strict";var _classCallCheck=function(a,b){if(!(a instanceof b))throw new TypeError("Cannot call a class as a function")},_createClass=function(){function a(a,b){for(var c=0;c<b.length;c++){var d=b[c];d.enumerable=d.enumerable||!1,d.configurable=!0,"value"in d&&(d.writable=!0),Object.defineProperty(a,d.key,d)}}return function(b,c,d){return c&&a(b.prototype,c),d&&a(b,d),b}}(),Console=function(){function a(a,b){var c=a.getDoc(),d=c.lastLine(),e=c.getLine(d),f=CodeMirror.Pos(d,e.length+1);return c.replaceRange(b,f),[f,CodeMirror.Pos(c.lastLine())]}var b=function(){function b(a){var c=this,d=void 0===arguments[1]?{}:arguments[1];_classCallCheck(this,b),d.theme=d.theme||"eclipse",d.mode=d.mode||"javascript",d.outputH=d.outputH||"auto",this.container=a,this.container.classList.add("jsconsole",d.theme),this.logBuffer=[],this.history=[],this.historyIndex=-1,this.events={};var e=function(){var a=c.input.getValue().trim();a&&c.exec(a)},f=function(){CodeMirror.commands.newlineAndIndent(c.input)},g=function(){c.resetInput()},h=function(a,b){var d=c.input.getCursor();0===d.line&&0===d.ch?(c.historyIndex++,c.historyIndex>c.history.length-1&&(c.historyIndex=c.history.length-1),c.resetInput(c.history[c.historyIndex])):CodeMirror.commands.goLineUp(c.input)},i=function(a,b){var d=c.input.getCursor(),e=c.input.lastLine();d.line===e?(c.historyIndex--,c.historyIndex<-1&&(c.historyIndex=-1),c.resetInput(c.history[c.historyIndex])):CodeMirror.commands.goLineDown(c.input)},j={Up:h,Down:i,"Ctrl-C":g,Enter:e,"Shift-Enter":f},k=document.createElement("div"),l=document.createElement("div");k.className="jsconsole-output",l.className="jsconsole-input",this.container.appendChild(k),this.container.appendChild(l),this.input=CodeMirror(l,{theme:d.theme,mode:d.mode,extraKeys:j,tabSize:2,indentUnit:2,undoDepth:100,lineWrapping:!0,viewportMargin:1/0,gutters:["repl"]}),this.output=CodeMirror(k,{theme:d.theme,mode:d.mode,gutters:["repl"],tabSize:2,viewportMargin:1/0,lineWrapping:!0,indentUnit:2,readOnly:!0}),this.resetOutput(),this.input.on("focus",function(){var a=c.output.getCursor();c.output.setSelection(a,a)}),this.output.on("focus",function(){var a=c.input.getCursor();c.input.setSelection(a,a)}),this.output.on("keydown",function(a,b){b.metaKey||b.ctrlKey?67===b.which||86===b.which&&c.input.triggerOnKeyDown(b):(c.input.triggerOnKeyDown(b),c.input.focus())}),k.addEventListener("mouseup",function(a){0===c.output.getSelection().length&&setTimeout(function(){return c.input.focus()},0)}),this.input.setMarker=this.output.setMarker=function(a,b){this.setGutterMarker(a,"repl",b.cloneNode())},this.resetInput()}return _createClass(b,[{key:"on",value:function(a,b){this.events[a]=b}},{key:"off",value:function(a){delete this.events[a]}},{key:"trigger",value:function(a,b){"function"==typeof this.events[a]&&this.events[a](b)}},{key:"flushLogBuffer",value:function(){var a=this;this.logBuffer.length&&(this.logBuffer.forEach(function(b){a.print(b),a.origConsoleLog(b)}),this.logBuffer.length=0)}},{key:"addHistory",value:function(a){this.historyIndex=-1,this.history.unshift(a)}},{key:"appendEntry",value:function(a,b){this.trigger("entry",{input:a,output:b});var c=this.appendOutput(a.toString().trim());this.output.setMarker(c[0].line,g);for(var d=c[0].line;d<=c[1].line;d++)d>c[0].line&&this.output.setMarker(d,h),this.output.addLineClass(d,"text","prev-command");this.flushLogBuffer();var f=this.parseOutput(b);c=this.appendOutput(f.formatted);var j=f.value instanceof Error;j?this.output.setMarker(c[0].line,e):this.output.setMarker(c[0].line,i);for(var d=c[0].line;d<=c[1].line;d++)this.output.addLineClass(d,"text","completion-value"),this.output.addLineClass(d,"text",f["class"]);this.output.addLineClass(c[1].line,"text","completion-value-end")}},{key:"parseOutput",value:function(a){var b=typeof a;a instanceof Error&&(b="error"),null===a&&(b="null");var c={value:a,type:b,"class":"type-"+b};switch(b){case"string":c.formatted='"'+a+'"',c["class"]="string";break;case"undefined":c.formatted="undefined";break;case"null":c.formatted="null";break;case"object":case"array":c.formatted=JSON.stringify(a);break;case"error":c.formatted=a.message.trim();break;default:c.formatted=a.toString().trim()}return c}},{key:"evaluate",value:function(a){var b={};try{b.completionValue=eval.call(null,a)}catch(c){b.error=!0,b.completionValue=c,b.recoverable=c instanceof SyntaxError&&c.message.match("^Unexpected (token|end)")}return b}},{key:"exec",value:function(a){var b=this;this.isEvaluating=!0;var e=this.evaluate(a);if(e){this.isEvaluating=!1;var f=this.input.getDoc();e.error&&!e.recoverable?(this.appendEntry(a,e.completionValue),this.addHistory(a),this.resetInput()):e.recoverable?CodeMirror.commands.newlineAndIndent(this.input):(this.appendEntry(a,e.completionValue),this.addHistory(a),this.resetInput()),f.eachLine(function(a){0===a.lineNo()?b.input.setMarker(a,c):b.input.setMarker(a,d)})}}},{key:"resetInput",value:function(){var a=void 0===arguments[0]?"":arguments[0];this.input.setValue(a.toString()),this.input.execCommand("goDocEnd"),this.input.setMarker(0,c)}},{key:"resetOutput",value:function(){this.output.setSize(null,8),this.output.setValue("")}},{key:"appendOutput",value:function(b){this.output.setSize(null,options.outputH);var c,d=this.output.getDoc();return d.getLine(d.lastLine()).match(/^\s*$/)?c=a(this.output,b.toString()):(c=a(this.output,"\n"+b.toString()),c[0].line=c[0].line+1),c}},{key:"print",value:function(a){for(var b=void 0===arguments[1]?"message":arguments[1],c=void 0===arguments[2]?document.createElement("span"):arguments[2],d=this.appendOutput(a),e=d[0].line;e<=d[1].line;e++)this.output.addLineClass(e,"text",b),this.output.setMarker(e,c);return d}},{key:"simpleFormatter",value:function(a){for(var b=arguments.length,c=Array(b>1?b-1:0),d=1;b>d;d++)c[d-1]=arguments[d];var e=0;return a.replace(/%./gm,function(a,b,d){return c[e++]})}},{key:"appendInput",value:function(b){return a(this.input,b.toString())}},{key:"wrapLog",value:function(a){var b=this,c=a.log.bind(a);return a.log=function(){for(var a=arguments.length,c=Array(a),d=0;a>d;d++)c[d]=arguments[d];b.logBuffer.push(b.simpleFormatter.apply(b,c)),b.isEvaluating||b.flushLogBuffer()},this.origConsoleLog=c}},{key:"setMode",value:function(a){this.input.setOption("mode",a),this.output.setOption("mode",a)}},{key:"setTheme",value:function(a){this.input.setOption("theme",a),this.output.setOption("theme",a)}}]),b}(),c=document.createElement("span"),d=document.createElement("span"),e=document.createElement("span"),f=document.createElement("span"),g=document.createElement("span"),h=document.createElement("span"),i=document.createElement("span");return e.className="console-error gutter-icon",f.className="console-info gutter-icon",c.className="prompt gutter-icon",d.className="prompt-continuation gutter-icon",g.className="prev-command gutter-icon",h.className="prev-command-continuation gutter-icon",i.className="completion-value gutter-icon",b}();
